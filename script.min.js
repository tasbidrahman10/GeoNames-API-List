$(document).ready(function () {
    $("#fetchBtn").on("click", function () {
        let location1 = $("#location1").val().trim();
        let location2 = $("#location2").val().trim();
        let location3 = $("#location3").val().trim();

        if (!location1 && !location2 && !location3) {
            alert("Please enter at least one location!");
            return;
        }

        $("#results").html("<p>Fetching data...</p>");

        let promises = [];

        // Fetch Weather API Data
        if (location1) {
            promises.push(fetchWeatherData(location1));
        }

        // Fetch Geographical API Data
        if (location2) {
            promises.push(fetchGeographicalData(location2));
        }

        // Fetch Population API Data
        if (location3) {
            promises.push(fetchPopulationData(location3));
        }

        // Process all API calls asynchronously
        Promise.all(promises)
            .then((results) => {
                $("#results").html(results.join("<br>"));
            })
            .catch((error) => {
                console.error("Error fetching data:", error);
                $("#results").html("<p style='color:red;'>Failed to fetch some data. Please try again.</p>");
            });
    });
});

function fetchWeatherData(location) {
    const geoUrl = `http://api.geonames.org/searchJSON?q=${location}&maxRows=1&username=dhanyaal19882`;

    return fetch(geoUrl)
        .then(response => response.json())
        .then(data => {
            if (data.geonames.length > 0) {
                let lat = data.geonames[0].lat;
                let lon = data.geonames[0].lng;

                // Now fetch the weather using lat/lon
                const weatherUrl = `http://api.geonames.org/findNearByWeatherJSON?lat=${lat}&lng=${lon}&username=dhanyaal19882`;

                return fetch(weatherUrl)
                    .then(response => response.json())
                    .then(weatherData => {
                        if (weatherData.weatherObservation) {
                            return `<p>üå§Ô∏è Weather in ${location}: <b>${weatherData.weatherObservation.temperature}¬∞C, ${weatherData.weatherObservation.clouds}</b></p>`;
                        } else {
                            return `<p>‚ö†Ô∏è No weather data found for ${location}.</p>`;
                        }
                    });
            } else {
                return `<p>‚ö†Ô∏è No geographical data found for ${location}.</p>`;
            }
        })
        .catch(() => `<p style="color:red;">‚ùå Weather API Error for ${location}.</p>`);
}

function fetchGeographicalData(location) {
    const url = `http://api.geonames.org/searchJSON?q=${location}&maxRows=1&username=dhanyaal19882`;

    return fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.geonames.length > 0) {
                let geo = data.geonames[0];
                return `<p>üìç ${location} Coordinates: <b>Lat: ${geo.lat}, Lon: ${geo.lng}</b></p>`;
            } else {
                return `<p>‚ö†Ô∏è No geographical data found for ${location}.</p>`;
            }
        })
        .catch(() => `<p style="color:red;">‚ùå Geographical API Error for ${location}.</p>`);
}

function fetchPopulationData(location) {
    const url = `http://api.geonames.org/searchJSON?q=${location}&maxRows=1&username=dhanyaal19882`;

    return fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.geonames.length > 0) {
                return `<p>üë• Population of ${location}: <b>${data.geonames[0].population || "Unknown"}</b></p>`;
            } else {
                return `<p>‚ö†Ô∏è No population data found for ${location}.</p>`;
            }
        })
        .catch(() => `<p style="color:red;">‚ùå Population API Error for ${location}.</p>`);
}
